-- ตารางสำหรับผู้ใช้ (Users)
CREATE TABLE users (
    id INTEGER NOT NULL AUTO_INCREMENT,
    display_name VARCHAR(255),
    username VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'USER',
    tier VARCHAR(50) NOT NULL DEFAULT 'PENDING',
    password_updated_at DATETIME NOT NULL,
    failed_login_attempts INTEGER NOT NULL DEFAULT 0,
    is_locked BOOLEAN NOT NULL DEFAULT FALSE,
    locked_until DATETIME,
    reset_token VARCHAR(255),
    reset_token_expiry DATETIME,
    created_at DATETIME NOT NULL,
    PRIMARY KEY (id),
    UNIQUE (username),
    UNIQUE (email),
    UNIQUE (reset_token),
    CHECK (role IN ('USER', 'ADMIN')),
    CHECK (tier IN ('PENDING', 'SAVER', 'PREMIUM'))
);

-- ตารางสำหรับเก็บประวัติการเข้าระบบ (Login Logs)
CREATE TABLE login_logs (
    id INTEGER NOT NULL AUTO_INCREMENT,
    username_attempt VARCHAR(255) NOT NULL,
    user_id INTEGER,
    timestamp DATETIME NOT NULL,
    is_success BOOLEAN NOT NULL,
    ip_address VARCHAR(50),
    PRIMARY KEY (id),
    FOREIGN KEY(user_id) REFERENCES users (id) ON DELETE SET NULL
);

-- ตารางสำหรับเก็บรายการสั่งอาหาร (Orders)
CREATE TABLE orders (
    id INTEGER NOT NULL AUTO_INCREMENT,
    user_id INTEGER NOT NULL,
    user_display_name VARCHAR(255) NOT NULL,
    ordered_at DATETIME NOT NULL,
    items JSON NOT NULL,
    PRIMARY KEY (id),
    FOREIGN KEY(user_id) REFERENCES users (id) ON DELETE CASCADE
);